---
layout: default
title: Wetter
---

<div
  class="
    mx-10-screen
    inline
    border-2 border-solid border-gray-500
    rounded-full
    text-gray-500
    px-4
    py-5
    relative
    text-center
    whitespace-nowrap
  "
>
  <input
    class="focus:outline-none bg-transparent w-52 text-2xl mx-8"
    id="search"
    type="text"
    placeholder="loading..."
  />
  <button
    class="
      border-none
      absolute
      top-2/4
      m-0
      p-0
      -mt-3
      -ml-4
      cursor-pointer
      bg-transparent
    "
    id="search-button"
  >
    <img class="h-6" src="search.svg" alt="" />
  </button>
</div>
<div class="liste" id="search-liste"></div>

<script>
  var search_input = document.getElementById("search");
  var search_liste_div = document.getElementById("search-liste");

  search_input.addEventListener("input", (e) => {
    show_autocomplete_results();
  });
  search_input.addEventListener("keyup", ({ key }) => {
    if (key === "Enter") search();
  });
  document.getElementById("search-button").addEventListener("click", () => {
    search();
  });

  async function fetch_json(url) {
    const response = await fetch(url);
    if (!response.ok) throw new Error(response.status);
    const data = await response.json();
    return data;
  }

  function show_autocomplete_results() {
    let input = search_input.value;
    if (!input || !locations_data) return;

    const results = fuzzysort.go(input, locations_data, {
      threshold: -20000,
      limit: 5,
      allowTypo: true,
      key: "name",
    });

    search_liste_div.textContent = "";
    results.forEach((result) => {
      let location_a = document.createElement("a");
      location_a.innerHTML = fuzzysort.highlight(result);
      location_a.href = "/show?location=" + result.obj.name;
      search_liste_div.appendChild(location_a);
      if (result.obj.meteoblue_src)
        search_liste_div.appendChild(document.createTextNode("*"));
      search_liste_div.appendChild(document.createElement("br"));
    });

    if (!results || results.length == 0) {
      let location_a = document.createElement("a");
      location_a.innerHTML = "-> erweiterte Suche";
      location_a.href = "javascript:void(0)";
      location_a.addEventListener("click", search);
      search_liste_div.appendChild(location_a);
    }
  }

  async function search() {
    let input = search_input.value;
    if (!input || input.length < 3) return;

    const data = awaitfetch_json(
      "https://nominatim.openstreetmap.org/search.php?q=" +
        input.toLowerCase().trim() +
        "&dedupe=1&accept-language=de&limit=5&format=jsonv2"
    );
    data = data.filter((element) => element.importance > 0.2);

    search_liste_div.textContent = "";
    data.forEach((result_element) => {
      let location_a = document.createElement("a");
      location_a.innerText = result_element.display_name;
      location_a.href =
        "/show?lat=" +
        Math.round(parseFloat(result_element.lat) * 100) / 100 +
        "&lon=" +
        Math.round(parseFloat(result_element.lon) * 100) / 100;
      search_liste_div.appendChild(location_a);
      search_liste_div.appendChild(document.createElement("br"));
    });

    if (!data || data.length == 0) {
      let location_p = document.createElement("a");
      location_p.innerHTML = "kein Ergebnis";
      search_liste_div.appendChild(location_p);
    }
  }

  function show_lastvisited() {
    let lastvisited;
    try {
      lastvisited = JSON.parse(localStorage.getItem("lastvisited")) || [];
    } catch (e) {
      lastvisited = [];
    }

    search_liste_div.textContent = "";
    search_liste_div.innerHTML =
      '<a href="/show?gps"><b>aktueller Standort</b></a><br>';
    lastvisited.forEach((element) => {
      let location_a = document.createElement("a");
      location_a.innerText = element.name;
      if (element.location) {
        location_a.href = "/show?location=" + element.location;
      } else if (element.lat && element.lon) {
        location_a.href = "/show?lat=" + element.lat + "&lon=" + element.lon;
      } else {
        return;
      }
      search_liste_div.appendChild(location_a);
      search_liste_div.appendChild(document.createElement("br"));
    });
  }

  show_lastvisited();
  window.addEventListener("pageshow", (event) => {
    if (
      event.persisted ||
      (typeof window.performance != "undefined" &&
        window.performance.navigation.type === 2)
    )
      show_lastvisited();
  });
  var locations_data;

  fetch_json("/locations.json").then((data) => {
    locations_data = data;
    search_input.setAttribute("placeholder", "Suche");
    show_autocomplete_results();
  });
</script>
